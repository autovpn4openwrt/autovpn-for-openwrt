# 介绍
Openwrt/Linux 自动翻墙智能翻墙方案。简单、粗暴、有效。IP层实现，但无需人为维护路由表，基本不影响正常上网。最少仅需500K左右的flash空间。

# 原理
* ### 翻墙需要解决两个问题： 

    1. 用什么方法翻

        > autovpn-for-openwrt 使用了 ppp over ssh 的方法来翻墙,当然您可以用 stunnel 等三层vpn替代
        
    2. 哪些（域名/IP）需要翻

        > autovpn-for-openwrt 用dnsmasq根据预配置的域名列表，将解析结果自动添加路由表，让系统通过路由表判断哪些IP需要翻墙

* ### 工作流程

    * 首先，通过 ppp over ssh 建立vpn连接。同时自动将IP：8.8.8.8 加入路由表，出口指向vpn接口（解决dns污染、劫持）；
    
    * 再配置dnsmasq，将被墙域名的DNS服务器配置为8.8.8.8（server=/xxxx.com/8.8.8.8）；
    
    * 用户访问被墙网站时，先发起 dns 请求，dnsmasq 收到用户 dns 请求，检查域名是否存在配置中，如是，则将查询请求转发到指定服务器(8.8.8.8)，dnsmasq得到解析结果调用指定的脚本将解析结果中的IP加入路由表，出口为vpn接口（15.05.1版本中配置vpn-if=pos-vpn;旧版配置：server-script=/path/to/routeadd.sh），然后将结果返回给用户；
    
    * 用户得到解析结果，向得到的ip发起连接，路由器根据这些ip的路由记录，将目数据流量从vpn接口转发出去。


# 技术方案

上述工作流程中，要为 dnsmasq 打上增加auto vpn功能的补丁，15.05.1版增加了 vpn-if 参数，去掉了routeadd.sh脚本，加路由的操作在dnsmasq中完成。旧版使用--server-script 参数，再配合routeadd.sh 脚本维护系统路由表，实现翻墙。依赖的组件少，易配置。

另外还有一种更原始的方案，让dnsmasq 维护 ipset，而非路由表，利用现有软件即可。但这种方案组件多配置有些复杂，因此不推荐，文档也不再维护

# 优缺点
  * 通网络层实现的优点是支持任何基于 IP 的协议，比如 ICMP、IPMI、TCP、UDP 等等上层的协议。
  
  * 对设备类型基本无要求，只要设备连到路由器上，任何运行在设备上的软件无需任何配置，就可以透明翻墙。
  
  * 相对于使用国家IP段构建路由表的方式，从域名解析结果自动构建路由表的方法更加轻量，按需添加，按需翻墙。无需翻墙就能访问的资源，不会浪费VPN流量，毕竟有时直接访问比走vpn是要快的。

  * 如果要访问的资源没有对应的域名，Luci中人为配置即可。
  
  * 默认内置的域名由 gfwlist 转换而来，并且不会自动更新，如有访问不了的资源，需手动添加。
  
  * 如果两个网站共用一个ip，其中一个被墙，另一个没有，那么没被墙的还是会翻墙，因为 autovpn-for-openwrt 是网络层实现的
  
# 安装配置

[移步至 wiki](https://github.com/autovpn4openwrt/autovpn-for-openwrt/wiki/Home)

